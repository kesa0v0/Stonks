services:
  # 1. 메인 데이터베이스
  postgres:
    image: postgres:18
    container_name: postgres-dev
    restart: unless-stopped
    volumes:
      - ./postgres-data:/var/lib/postgresql
    environment:
      - POSTGRES_USER=devuser
      - POSTGRES_PASSWORD=devpassword
    ports:
      - "5432:5432"

  # 2. 인메모리 캐시 DB
  redis:
    image: redis:8
    container_name: redis-dev
    restart: unless-stopped
    ports:
      - "6379:6379"

    # 3. RabbitMQ (매니지먼트 플러그인 포함 버전)
  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq-dev
    ports:
      - "5672:5672"   # 통신 포트
      - "15672:15672" # 관리자 웹 UI (http://localhost:15672)

  api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: dev-api
    command: uvicorn backend.app.main:app --host 0.0.0.0 --port 8000 --reload
    volumes:
      # [핵심] 내 컴퓨터의 backend 폴더를 컨테이너의 /app/backend로 연결
      # 코드를 수정하면 컨테이너 안의 파일도 바뀌어서 uvicorn이 재시작됨
      - ./backend:/app/backend
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://devuser:devpass@postgres:5432/dev_db
      - REDIS_HOST=redis
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_USER=guest
      - RABBITMQ_PASS=guest
      # JWT 시크릿 등은 개발용 임의 값
      - SECRET_KEY=dev_secret_key
      - ALGORITHM=HS256
      - PYTHONUNBUFFERED=1
    depends_on:
      - postgres
      - redis
      - rabbitmq

  # 5. 데이터 수집 워커 (Data Feeder)
  worker_data:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: dev-worker-data
    # [중요] API 서버와 달리, 얘는 백그라운드에서 python 파일을 직접 실행합니다.
    command: python -m backend.worker.data_feeder
    volumes:
      - ./backend:/app/backend # 코드 수정 시 즉시 반영 (Hot Reload는 안 되지만 재시작하면 됨)
    environment:
      - DATABASE_URL=postgresql://devuser:devpass@postgres:5432/dev_db
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - DEBUG=True
      - PYTHONUNBUFFERED=1
    depends_on:
      - redis

volumes:
  dev_postgres_data: