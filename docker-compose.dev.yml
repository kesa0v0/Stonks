services:
  # 1. 메인 데이터베이스
  postgres:
    image: postgres:18
    container_name: postgres-dev
    volumes:
      - ./postgres-data:/var/lib/postgresql
    environment:
      - POSTGRES_USER=devuser
      - POSTGRES_PASSWORD=devpass
      - POSTGRES_DB=dev_db
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U devuser -d dev_db"]
      interval: 10s
      timeout: 10s
      retries: 5

  # 2. 인메모리 캐시 DB
  redis:
    image: redis:8
    container_name: redis-dev
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 10s
      retries: 5

    # 3. RabbitMQ (매니지먼트 플러그인 포함 버전)
  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq-dev
    ports:
      - "5672:5672"   # 통신 포트
      - "15672:15672" # 관리자 웹 UI (http://localhost:15672)
    healthcheck:
      test: ["CMD", "rabbitmqctl", "status"]
      interval: 10s
      timeout: 10s
      retries: 5

  api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: dev-api
    command: uvicorn backend.app.main:app --host 0.0.0.0 --port 8000 --reload
    volumes:
      # [핵심] 내 컴퓨터의 backend 폴더를 컨테이너의 /app/backend로 연결
      # 코드를 수정하면 컨테이너 안의 파일도 바뀌어서 uvicorn이 재시작됨
      - ./backend:/app/backend
    ports:
      - "8000:8000"
    env_file:
      - ./.env
    environment:
      - DATABASE_URL=postgresql://devuser:devpass@postgres:5432/dev_db
      - REDIS_HOST=redis
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_USER=guest
      - RABBITMQ_PASS=guest
      # JWT 시크릿 등은 개발용 임의 값
      - ALGORITHM=HS256
      - PYTHONUNBUFFERED=1
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
      rabbitmq:
        condition: service_started

  # 5. 데이터 수집 워커 (Data Feeder)
  worker_data:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: dev-worker-data
    # [중요] API 서버와 달리, 얘는 백그라운드에서 python 파일을 직접 실행합니다.
    command: python -m backend.worker.data_feeder
    volumes:
      - ./backend:/app/backend # 코드 수정 시 즉시 반영 (Hot Reload는 안 되지만 재시작하면 됨)
    env_file:
      - ./.env
    environment:
      - DATABASE_URL=postgresql://devuser:devpass@postgres:5432/dev_db
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - DEBUG=True
      - PYTHONUNBUFFERED=1
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started

# 6. 주문 체결 워커 (Trade Worker)
  worker_trade:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: dev-worker-trade
    command: python -m backend.worker.trade_consumer
    volumes:
      - ./backend:/app/backend
    env_file:
      - ./.env
    environment:
      - DATABASE_URL=postgresql://devuser:devpass@postgres:5432/dev_db
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_USER=guest
      - RABBITMQ_PASS=guest
      - DEBUG=True
      - PYTHONUNBUFFERED=1
    depends_on:
      rabbitmq:
        condition: service_healthy
      postgres:
        condition: service_healthy

  worker_matcher:
    build:
      context: ./backend
      dockerfile: Dockerfile
    command: python -m backend.worker.limit_matcher
    volumes:
      - ./backend:/app/backend
    env_file:
      - ./.env
    environment:
      - DATABASE_URL=postgresql://devuser:devpass@postgres:5432/dev_db
      - REDIS_HOST=redis
      - PYTHONUNBUFFERED=1
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started

  worker_human_matcher:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: dev-worker-human-matcher
    command: python -m backend.worker.human_matcher
    volumes:
      - ./backend:/app/backend
    env_file:
      - ./.env
    environment:
      - DATABASE_URL=postgresql://devuser:devpass@postgres:5432/dev_db
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - PYTHONUNBUFFERED=1
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started

  # 7. 캔들 수집 워커 (Candle Collector)
  worker_candle:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: dev-worker-candle
    command: python -m backend.worker.candle_collector
    volumes:
      - ./backend:/app/backend
    env_file:
      - ./.env
    environment:
      - DATABASE_URL=postgresql://devuser:devpass@postgres:5432/dev_db
      - REDIS_HOST=redis
      - PYTHONUNBUFFERED=1
    depends_on:
      postgres:
        condition: service_healthy

  # 8. 마진 감시 워커 (Margin Watcher)
  worker_margin:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: dev-worker-margin
    command: python -m backend.worker.margin_watcher
    volumes:
      - ./backend:/app/backend
    env_file:
      - ./.env
    environment:
      - DATABASE_URL=postgresql://devuser:devpass@postgres:5432/dev_db
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - PYTHONUNBUFFERED=1
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started

  # 11. 알림 워커 (Discord 웹훅 전송)
  worker_notify:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: dev-worker-notify
    command: python -m backend.worker.notification_worker
    volumes:
      - ./backend:/app/backend
    env_file:
      - ./.env
    environment:
      - DATABASE_URL=postgresql://devuser:devpass@postgres:5432/dev_db
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - PYTHONUNBUFFERED=1
    depends_on:
      redis:
        condition: service_started

  # 12. 일일 리포트 워커 (수동/크론대신 외부 스케줄러 사용 시 단발 실행)
  worker_daily_report:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: dev-worker-daily-report
    command: python -m backend.worker.daily_reporter
    volumes:
      - ./backend:/app/backend
    env_file:
      - ./.env
    environment:
      - DATABASE_URL=postgresql://devuser:devpass@postgres:5432/dev_db
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - PYTHONUNBUFFERED=1
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started

  # 13. 디스코드 봇 (Slash Commands)
  discord_bot:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: dev-discord-bot
    command: python -m backend.worker.discord_bot.bot
    volumes:
      - ./backend:/app/backend
    env_file:
      - ./.env
    environment:
      - DATABASE_URL=postgresql://devuser:devpass@postgres:5432/dev_db
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - PYTHONUNBUFFERED=1
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
  # 9. 부하 테스트 도구 (Locust)
  locust:
    image: locustio/locust
    container_name: locust-dev
    ports:
      - "8089:8089" # 웹 인터페이스 포트
    volumes:
      - ./backend/tests/load:/mnt/locust
    command: -f /mnt/locust/locustfile.py
    environment:
      - LOCUST_HOST=http://api:8000 # API 서버 주소 (Docker Network)

  # 10. 관리자 대시보드 (Streamlit)
  admin_dashboard:
    image: python:3.11-slim
    container_name: admin-dashboard
    working_dir: /app
    volumes:
      - ./admin_dashboard:/app
    command: >
      bash -c "pip install -r requirements.txt && streamlit run app.py --server.port 8501 --server.address 0.0.0.0"
    ports:
      - "8501:8501"
    environment:
      - API_URL=http://api:8000/api/v1 # Docker Network 내부 통신
    depends_on:
      - api

volumes:
  dev_postgres_data: